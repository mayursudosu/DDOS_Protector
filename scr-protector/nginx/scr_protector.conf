# =============================================================================
# scr-protector: NGINX Rate Limiting Snippet
# =============================================================================
# This file is included in NGINX server blocks to enable rate limiting
# and the challenge page redirect.
#
# Installation:
#   Placed at: /etc/nginx/snippets/scr_protector.conf
#
# Usage in server block:
#   include /etc/nginx/snippets/scr_protector.conf;
#   limit_req zone=scr_limit burst=20 nodelay;
#   error_page 429 = /__scr_challenge;
# =============================================================================

# -----------------------------------------------------------------------------
# Rate Limiting Zone
# -----------------------------------------------------------------------------
# Tracks requests per IP address in a 10MB shared memory zone.
# Rate: 10 requests per second (configurable via config.yaml)
#
# Why 10MB: Can track approximately 160,000 unique IPs
# Why 10r/s: Reasonable for most sites; adjust based on your needs
#
# Note: This line should appear in http {} context. If you're including
# this in a server {} block, move this line to /etc/nginx/nginx.conf
# inside the http {} block, or use a separate conf.d file.
# -----------------------------------------------------------------------------

# Uncomment the following line if including in http {} context:
# limit_req_zone $binary_remote_addr zone=scr_limit:10m rate=10r/s;

# -----------------------------------------------------------------------------
# Real IP Configuration (for reverse proxies like Cloudflare)
# -----------------------------------------------------------------------------
# Uncomment and configure if behind a reverse proxy:
#
# set_real_ip_from 103.21.244.0/22;
# set_real_ip_from 103.22.200.0/22;
# set_real_ip_from 103.31.4.0/22;
# set_real_ip_from 104.16.0.0/13;
# set_real_ip_from 104.24.0.0/14;
# set_real_ip_from 108.162.192.0/18;
# set_real_ip_from 131.0.72.0/22;
# set_real_ip_from 141.101.64.0/18;
# set_real_ip_from 162.158.0.0/15;
# set_real_ip_from 172.64.0.0/13;
# set_real_ip_from 173.245.48.0/20;
# set_real_ip_from 188.114.96.0/20;
# set_real_ip_from 190.93.240.0/20;
# set_real_ip_from 197.234.240.0/22;
# set_real_ip_from 198.41.128.0/17;
# real_ip_header CF-Connecting-IP;

# -----------------------------------------------------------------------------
# Challenge Page Location
# -----------------------------------------------------------------------------
# Serves the challenge page when a client exceeds the rate limit.
# The challenge page includes JavaScript that:
# 1. Displays a brief "verifying" message
# 2. Sets a pass cookie after a short delay
# 3. Redirects the user back to their original request
# -----------------------------------------------------------------------------

location = /__scr_challenge {
    # Serve challenge page from site's .scr-protector directory
    # <SITE_ROOT_PLACEHOLDER> is replaced during installation
    root <SITE_ROOT_PLACEHOLDER>;
    try_files /.scr-protector/challenge.html =404;
    
    # Don't log challenge requests (reduces noise)
    access_log off;
    
    # No caching of challenge page
    add_header Cache-Control "no-store, no-cache, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# -----------------------------------------------------------------------------
# Block access to .scr-protector directory
# -----------------------------------------------------------------------------
# Prevent direct access to the hidden directory except via challenge
location ~ /\.scr-protector {
    deny all;
    return 404;
}

# =============================================================================
# ANUBIS INTEGRATION
# =============================================================================
# 
# Anubis (https://anubis.techaro.lol) provides Layer-0 bot protection
# through browser challenges. When USE_ANUBIS=true in config.yaml,
# the local challenge.html is disabled and Anubis handles verification.
#
# — ANUBIS START —
# Insert your Anubis client-side script in your site's <head>, e.g.:
#
# <script src="https://anubis.techaro.lol/static/js/anubis.js" data-sitekey="YOUR_KEY"></script>
# <noscript><meta http-equiv="refresh" content="0; url=/__scr_challenge"></noscript>
#
# — ANUBIS END —
#
# Setup instructions:
# 1. Register at https://anubis.techaro.lol and obtain your site key
# 2. Add the Anubis script to your website's <head> section
# 3. Set USE_ANUBIS: true in /opt/scr-protector/config.yaml
# 4. Re-run install.sh or restart services
#
# When Anubis is active, rate-limited clients are still redirected to
# /__scr_challenge but Anubis handles the bot verification instead of
# the built-in JavaScript challenge.
#
# =============================================================================

# -----------------------------------------------------------------------------
# Custom Log Format for Parser
# -----------------------------------------------------------------------------
# Uncomment to use custom log format that includes rate limit status:
#
# log_format scr_protector '$remote_addr - $remote_user [$time_local] '
#                          '"$request" $status $body_bytes_sent '
#                          '"$http_referer" "$http_user_agent" '
#                          'rt=$request_time uct="$upstream_connect_time" '
#                          'uht="$upstream_header_time" urt="$upstream_response_time"';
#
# access_log /var/log/nginx/access.log scr_protector;
# -----------------------------------------------------------------------------
